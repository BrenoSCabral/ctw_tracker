<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CTW Tracker</title>
  <link rel="apple-touch-icon" sizes="180x180" href="favicon_io/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon_io/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon_io/favicon-16x16.png">
  <link rel="manifest" href="favicon_io/site.webmanifest">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #f8f9fa;
      overflow: hidden;
    }

    @media (max-width: 768px) {
      #chart-panel {
        top: 60px; /* respeita a navbar */
        height: calc(100% - 60px);
      }

      #chart-panel.open {
        top: 0;
        left: 0;
        width: 100% !important;
        height: 100% !important;
        z-index: 3000;
      }

      #chart-frame {
        height: 100%;
      }
    }

    #map {
      width: 100%;
      height: 100%;
      transition: width 0.2s ease;
    }

    /* Painel lateral */
    #chart-panel {
      position: absolute;
      top: 60px;
      right: 0;
      width: 0;
      height: 100%;
      background: #fff;
      box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
      display: flex;
      flex-direction: column;
      z-index: 1000;
      overflow: hidden;
      transition: width 0.2s ease;
    }

    #chart-panel.open {
      width: 60%;
    }

    #chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      border-bottom: 1px solid #ddd;
      background: #f5f5f5;
    }

    #chart-header h2 {
      font-size: 1rem;
      margin: 0;
    }

    #close-btn {
      cursor: pointer;
      font-size: 20px;
      color: #333;
      border: none;
      background: none;
    }

    #chart-frame {
      flex: 1;
      width: 100%;
      border: none;
    }

    .site-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #333;
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 6px 12px;
      transition: color 0.3s ease;
    }

    .site-title:hover {
      color: #007bff;
    }

    .glass-navbar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px;
      backdrop-filter: blur(12px);
      background: rgba(255, 255, 255, 0.2);
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .navbar-content {
      width: 90%;
      max-width: 1200px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .navbar-buttons button {
      margin-left: 12px;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      background: rgba(0, 123, 255, 0.8);
      color: white;
      cursor: pointer;
      font-size: 0.85rem;
      transition: background 0.3s ease;
    }

    .navbar-buttons button:hover {
      background: rgba(0, 123, 255, 1);
    }

    /* Modal Sobre */
    #about-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 4000;
      justify-content: center;
      align-items: center;
    }

    #about-box {
      background: white;
      padding: 32px;
      border-radius: 12px;
      max-width: 450px;
      width: 90%;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    #about-box h3 {
      margin: 0 0 20px 0;
      color: #333;
      font-size: 1.5rem;
      width: 100%;
    }

    #about-box p {
      line-height: 1.5;
      color: #555;
      margin: 0 0 16px 0;
      width: 100%;
      text-align: center;
    }

    #about-box a {
      color: #007bff;
      text-decoration: none;
    }

    #about-box a:hover {
      text-decoration: underline;
    }

    #about-box button {
      margin-top: 8px;
      padding: 10px 24px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s ease;
    }

    #about-box button:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>
<nav class="glass-navbar">
  <div class="navbar-content">
    <button class="site-title" onclick="goHome()">CTW Tracker</button>
    <div class="navbar-buttons">
      <button id="about-btn" onclick="openAbout()">Sobre</button>
      <button id="lang-btn">EN / PT</button>
    </div>
  </div>
</nav>

<div id="map"></div>

<div id="info-box" style="
  position: absolute;
  top: 70px;
  right: 20px;
  max-width: 300px;
  background: rgba(255,255,255,0.9);
  padding: 12px 16px;
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  font-size: 0.85rem;
  font-family: system-ui, sans-serif;
  color: #333;
  display: none;
  z-index: 1500;
">
</div>

<div id="chart-panel">
  <div id="chart-header">
    <h2 id="station-name">Estação</h2>
    <button id="close-btn" title="Fechar">×</button>
  </div>
  <iframe id="chart-frame"></iframe>
</div>

<!-- Modal Sobre -->
<div id="about-modal">
  <div id="about-box">
    <h3 id="about-title">Sobre o CTW Tracker</h3>
    <p id="about-description">
      Aplicação interativa para monitoramento em tempo real das ondas confinadas costeiras (CTWs) na margem continental brasileira, com dados do <a href="https://www.simcosta.furg.br/home" target="_blank">SIMCosta</a>.
    </p>
    <!-- <p id="about-author">Desenvolvido por <strong>Breno Cabral</strong>.</p> -->
    <p id="about-code">Código da aplicação disponível <a href="https://github.com/BrenoSCabral/ctw_tracker" target="_blank" title="GitHub">aqui</a></p>
    <button id="about-close-btn" onclick="closeAbout()">Fechar</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  // Mapa inicial
  const map = L.map('map', {
    zoomControl: false,
    attributionControl: false
  }).setView([-20, -44], 4);

  // Camada base clean
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    maxZoom: 12
  }).addTo(map);

  const pinIcon = L.icon({
    iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
    iconSize: [25, 40],
    iconAnchor: [12, 40],
    popupAnchor: [0, -30]
  });

  const chartPanel = document.getElementById('chart-panel');
  const chartFrame = document.getElementById('chart-frame');
  const stationName = document.getElementById('station-name');
  const closeBtn = document.getElementById('close-btn');
  const aboutModal = document.getElementById('about-modal');
  const langBtn = document.getElementById('lang-btn');
  const aboutBtn = document.getElementById('about-btn');

  // Elementos para tradução
  const aboutTitle = document.getElementById('about-title');
  const aboutDescription = document.getElementById('about-description');
  // const aboutAuthor = document.getElementById('about-author');
  const aboutCode = document.getElementById('about-code')
  const aboutCloseBtn = document.getElementById('about-close-btn');

  let activeStation = null;
  let isEnglish = false;

  function openChart(station) {
    activeStation = station;

    // Abre o painel lateral
    chartPanel.classList.add('open');
    chartFrame.src = station.file;
    stationName.textContent = station.name;

    // Espera animação/resize e então reajusta o mapa
    setTimeout(() => {
      const targetZoom = 8;
      const positionFraction = 1;

      const latlng = L.latLng(station.lat, station.lon);
      const point = map.project(latlng, targetZoom);

      const latlng1 = L.latLng(station.lat, station.lon + 3);
      const point1 = map.project(latlng1, targetZoom);

      const diffX = point1.x - point.x;
      const newPoint = point.add([diffX, 0]);
      const newCenter = map.unproject(newPoint, targetZoom);

      // muda a vista para o novo centro + zoom
      map.setView(newCenter, targetZoom, { animate: true });
    }, 350);
  }

  function closeChart() {
    chartPanel.classList.remove('open');
    chartFrame.src = '';
    activeStation = null;

    // Espera o painel fechar para reajustar o mapa
    setTimeout(() => {
      map.invalidateSize();
      map.setView([-20, -44], 4, { animate: true });
    }, 350);
  }

  closeBtn.addEventListener('click', closeChart);

  // ========== Funções da Navbar ==========
  function goHome() {
    closeChart(); // Fecha painel lateral se estiver aberto
    map.setView([-20, -44], 4, { animate: true }); // Volta à visão inicial
  }

  function openAbout() {
    aboutModal.style.display = 'flex';
  }

  function closeAbout() {
    aboutModal.style.display = 'none';
  }

  // Fechar modal clicando fora
  aboutModal.addEventListener('click', function(e) {
    if (e.target === aboutModal) {
      closeAbout();
    }
  });

  // ========== Sistema de Tradução ==========
  function toggleLanguage() {
    if (!isEnglish) {
      // Mudar para Inglês
      langBtn.textContent = 'PT / EN';
      aboutBtn.textContent = 'About';
      aboutTitle.textContent = 'About CTW Tracker';
      aboutDescription.innerHTML = 'Interactive application for real-time monitoring of coastal trapped waves (CTWs) on the Brazilian continental margin, with data from <a href="https://www.simcosta.furg.br/home" target="_blank">SIMCosta</a>.';
      // aboutAuthor.innerHTML = 'Developed by <strong>Breno Cabral</strong>.';
      aboutCode.innerHTML = 'Application code available <a href="https://github.com/BrenoSCabral/ctw_tracker" target="_blank" title="GitHub">here</a>';
      aboutCloseBtn.textContent = 'Close';
      stationName.textContent = 'Station'; // Atualiza o título do painel se estiver aberto
    } else {
      // Mudar para Português
      langBtn.textContent = 'EN / PT';
      aboutBtn.textContent = 'Sobre';
      aboutTitle.textContent = 'Sobre o CTW Tracker';
      aboutDescription.innerHTML = 'Aplicação interativa para monitoramento em tempo real das ondas confinadas costeiras (CTWs) na margem continental brasileira, com dados do <a href="https://www.simcosta.furg.br/home" target="_blank">SIMCosta</a>.';
      // aboutAuthor.innerHTML = 'Desenvolvido por <strong>Breno Cabral</strong>.';
      aboutCode.innerHTML = 'Código da aplicação disponível <a href="https://github.com/BrenoSCabral/ctw_tracker" target="_blank" title="GitHub">aqui</a>';
      aboutCloseBtn.textContent = 'Fechar';
      stationName.textContent = 'Estação'; // Atualiza o título do painel se estiver aberto
    }
    isEnglish = !isEnglish;
  }

  // Adicionar evento de clique ao botão de idioma
  langBtn.addEventListener('click', toggleLanguage);

  // Carrega estações
  fetch('infos.json')
    .then(response => response.json())
    .then(stations => {
      stations.forEach(st => {
        const marker = L.marker([st.lat, st.lon], { icon: pinIcon }).addTo(map);
        marker.bindTooltip(st.name, { permanent: false, direction: 'top' });
        marker.on('click', () => openChart(st));
      });
    })
    .catch(err => console.error('Erro ao carregar infos.json:', err));
</script>
</body>
</html>